#!/bin/sh
# CPU frequency control for ASUS Eee PC 701

if [ ! -e /proc/eee/fsb ]; then
	echo "Can't find /proc/eee/fsb"
	echo "eeepc-linux module not loaded?"
	exit 1
fi

usage () {
	echo " Usage:  eeecpufreq [-f frequency] [-p]"
	exit 0
}

get_fsb () {
	current_fsb=`cat /proc/eee/fsb | cut -d " " -f1`
}

set_freq () {
	if [ -z "$1" ]; then usage; fi
	if [ "$(id -u)" != "0" ]; then
		echo "This script must be run as root" 1>&2
		exit 1
	fi
	if [ $1 -lt 630 -o $1 -gt 900 ]; then
		echo "Must be in range between 630 and 900"
		exit 1
	fi
	let target_fsb=$1/9
	get_fsb
	if [ $current_fsb -lt $target_fsb ]; then
		while [ $current_fsb -lt $target_fsb ]; do
			let new_fsb=$current_fsb+1
			if [ $new_fsb -gt 75 ]; then
				echo "$new_fsb 24 1" > /proc/eee/fsb
			else
				echo "$new_fsb 24 0" > /proc/eee/fsb
			fi
			sleep 0.05s
			get_fsb
		done
	else
		while [ $current_fsb -gt $target_fsb ]; do
			let new_fsb=$current_fsb-1
			if [ $new_fsb -gt 75 ]; then
				echo "$new_fsb 24 1" > /proc/eee/fsb
			else
				echo "$new_fsb 24 0" > /proc/eee/fsb
			fi
			sleep 0.05s
			get_fsb
		done
	fi
	exit 0
}

print_freq () {
	let current_freq=`cat /proc/eee/fsb | cut -d " " -f1`*9
	echo "Current frequency:  $current_freq MHz"
	exit 0
}

case "$1" in
	-p)		print_freq;;
	-f)		set_freq $2;;
	 *)		usage;;
esac
